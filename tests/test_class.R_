library(R6)

d3 <- R6Class("d3",
                      public = list(
                        script = NULL,
                        style = NULL,
                        html = NULL,
                        data = NULL,
                        title = NULL,
                        mode = NULL,
                        dir = NULL,
                        width = 600,
                        height = 400,

                        initialize = function(script, style = NULL, html = NULL, data = NULL,
                                              title = NULL, mode = NULL, dir = NULL, width = 600, height = 400) {
                          self$script <- script
                          self$style <- ifelse(is.null(style), '', style)
                          self$html <- ifelse(is.null(html), self$default_html(), html)
                          self$data <- data
                          self$title <- title
                          self$mode <- mode
                          self$dir <- ifelse(is.null(dir), '', dir)
                          self$width <- width
                          self$height <- height
                        },

                        default_html = function() {
                          return(' <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>d3r</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>%s</style>
</head>
<body>
    <div id="container"></div>
    <script>%s</script>
</body>
</html>')
                        },

                        render = function() {
                          if (!is.null(self$title)) {
                            title_script <- sprintf('// Set title\nd3.select("#container")\n  .insert("h2", ":first-child")\n  .text("%s");', self$title)
                            self$script <- paste(title_script, self$script, sep = '\n')
                          }

                          if (!is.null(self$data)) {
                            data_script <- sprintf('// Inject data\nconst data = %s;', self$data)
                            self$script <- paste(data_script, self$script, sep = '\n')
                          }

                          full_html <- sprintf(self$html, self$style, self$script)

                          if (is.null(self$mode)) {
                            serve_html(full_html, self$dir)
                            return()
                          }

                          mode <- tolower(self$mode)

                          switch(mode,
                                 "jupyter"   = IRdisplay::display_html(full_html),
                                 "rstudio"   = serve_rstudio(full_html),
                                 "quarto"    = serve_quarto(full_html, dir = self$dir, width = self$width, height = self$height),
                                 "shiny"     = serve_shiny(full_html, width = self$width, height = self$height),
                                 "selenium"  = serve_selenium(full_html),
                                 message("Invalid mode. Available modes: NULL, Jupyter, RStudio, Quarto, Shiny, Selenium")
                          )
                        }
                      )
)

d3
